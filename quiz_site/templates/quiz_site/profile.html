{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/quiz_site/profile.css' %}">
{% endblock %}

{% block content %}
    <div class="profile-container">
        <div class="profile-header">
            <h1 class="page-title">My Profile</h1>
        </div>

        <div class="profile-content">
            <!-- Stats Section - Moved to Top -->
            {% if player %}
            <div class="profile-section stats-section">
                <div class="section-header">
                    <h2 class="section-title">Quiz Statistics</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value">{{ player.all_time_score|floatformat:1 }}</div>
                        <div class="stat-label">Total Score</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-value">{{ player.all_time_incorrect }}</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value">{{ player.all_time_questions }}</div>
                        <div class="stat-label">Questions</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">‚úì</div>
                        <div class="stat-value">
                            {% if player.all_time_questions > 0 %}
                                {% widthratio player.all_time_score player.all_time_questions 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Profile Photo Section -->
            <div class="profile-section photo-section">
                <div class="section-header">
                    <h2 class="section-title">Profile Photo</h2>
                </div>
                <div class="photo-container">
                    <div class="current-photo">
                        {% if player and player.player_photo %}
                            <img src="{{ player.player_photo.url }}" alt="Profile photo" class="profile-photo">
                        {% else %}
                            <div class="no-photo-placeholder">
                                <span class="placeholder-icon">üë§</span>
                                <span class="placeholder-text">No photo uploaded</span>
                            </div>
                        {% endif %}
                    </div>
                    <form method="post" enctype="multipart/form-data" class="photo-upload-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="upload_photo">
                        <div class="form-group">
                            <label for="photo" class="file-label">
                                {% if player and player.player_photo %}
                                    üì∑ Change Photo
                                {% else %}
                                    üì∑ Upload Photo
                                {% endif %}
                            </label>
                            <input type="file" id="photo" name="photo" accept="image/*" class="file-input">
                            <div class="file-preview" id="photoPreview"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Photo</button>
                    </form>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="profile-section info-section">
                <div class="section-header">
                    <h2 class="section-title">Personal Information</h2>
                </div>
                
                <!-- Username Form -->
                <form method="post" class="info-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_username">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="username" 
                                name="username" 
                                value="{{ user.username }}"
                                class="text-input"
                                required
                            >
                            <button type="submit" class="btn btn-secondary">Update</button>
                        </div>
                    </div>
                </form>

                <!-- Email Form -->
                <form method="post" class="info-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_email">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <div class="input-group">
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                value="{{ user.email }}"
                                class="text-input"
                                placeholder="your.email@example.com"
                            >
                            <button type="submit" class="btn btn-secondary">Update</button>
                        </div>
                    </div>
                </form>

                <!-- Date of Birth Form -->
                <form method="post" class="info-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_dob">
                    <div class="form-group">
                        <label for="date_of_birth">Date of Birth:</label>
                        <div class="input-group">
                            <input 
                                type="date" 
                                id="date_of_birth" 
                                name="date_of_birth" 
                                value="{% if player and player.player_dob %}{{ player.player_dob|date:'Y-m-d' }}{% endif %}"
                                class="date-input"
                            >
                            <button type="submit" class="btn btn-secondary">Update</button>
                        </div>
                        {% if player and player.player_dob %}
                            <small class="field-help">Currently: {{ player.player_dob|date:"F d, Y" }}</small>
                        {% else %}
                            <small class="field-help warning">Not set</small>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Password Change Section -->
            <div class="profile-section password-section">
                <div class="section-header">
                    <h2 class="section-title">Change Password</h2>
                </div>
                
                <form method="post" class="password-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="change_password">
                    
                    <div class="form-group">
                        <label for="new_password">New Password:</label>
                        <input type="password" id="new_password" name="new_password" required minlength="8">
                        <small class="password-hint">Password must be at least 8 characters long</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">Confirm New Password:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required minlength="8">
                    </div>
                    
                    <button type="submit" class="btn btn-danger">Change Password</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Photo preview
        const photoInput = document.getElementById('photo');
        const photoPreview = document.getElementById('photoPreview');

        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.innerHTML = `
                        <div class="preview-container">
                            <img src="${e.target.result}" alt="Preview">
                            <span class="preview-text">Preview</span>
                        </div>
                    `;
                }
                reader.readAsDataURL(file);
            }
        });

        // Password validation
        const passwordForm = document.querySelector('.password-form');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_password').value;

                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('New passwords do not match!');
                    return false;
                }

                if (newPassword.length < 8) {
                    e.preventDefault();
                    alert('Password must be at least 8 characters long!');
                    return false;
                }
            });
        }
    </script>
{% endblock %}
