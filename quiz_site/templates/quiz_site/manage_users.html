{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/quiz_site/manage_users.css' %}">
{% endblock %}

{% block content %}
    <div class="manage-users-container">
        <div class="header-section">
            <h1 class="page-title">Manage Users</h1>
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number">{{ total_users }}</span>
                    <span class="stat-label">Total Users</span>
                </div>
            </div>
        </div>

        <div class="users-grid">
            {% for profile in user_profiles %}
                <div class="user-card {% if not profile.has_photo or not profile.player.player_dob %}incomplete{% endif %}">
                    <div class="user-header">
                        <div class="user-avatar">
                            {% if profile.has_photo %}
                                <img src="{{ profile.photo_url }}" alt="Profile photo" class="profile-photo">
                            {% else %}
                                <div class="no-photo">üë§</div>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <h3 class="username">
                                {% if profile.has_photo and profile.player.player_dob %}
                                    <span class="profile-complete-icon">‚úì</span>
                                {% else %}
                                    <span class="profile-incomplete-icon">‚ö†</span>
                                {% endif %}
                                {{ profile.user.username }}
                            </h3>
                            <p class="email">{{ profile.user.email|default:"No email" }}</p>
                        </div>
                    </div>

                    <div class="user-details">
                        <div class="detail-row">
                            <span class="label">Joined:</span>
                            <span class="value">{{ profile.date_joined|date:"M d, Y" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Last Login:</span>
                            <span class="value">
                                {% if profile.last_login %}
                                    {{ profile.last_login|date:"M d, Y H:i" }}
                                {% else %}
                                    Never
                                {% endif %}
                            </span>
                        </div>
                        {% if profile.player %}
                            <div class="detail-row">
                                <span class="label">Profile Photo:</span>
                                <span class="value photo-status">
                                    {% if profile.has_photo %}
                                        <span class="has-photo">‚úì Uploaded</span>
                                    {% else %}
                                        <span class="no-photo-status">‚úó Not uploaded</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Date of Birth:</span>
                                <span class="value">
                                    {% if profile.player.player_dob %}
                                        {{ profile.player.player_dob|date:"M d, Y" }}
                                    {% else %}
                                        Not set
                                    {% endif %}
                                </span>
                            </div>
                        {% else %}
                            <div class="detail-row">
                                <span class="label">Profile:</span>
                                <span class="value warning">No player profile</span>
                            </div>
                        {% endif %}
                    </div>

                    <div class="user-actions">
                        <button class="btn btn-secondary reset-password-btn"
                                data-user-id="{{ profile.user.id }}"
                                data-username="{{ profile.user.username }}">
                            üîë Reset Password
                        </button>
                        {% if not profile.has_photo %}
                            <button class="btn btn-primary upload-photo-btn"
                                    data-user-id="{{ profile.user.id }}"
                                    data-username="{{ profile.user.username }}">
                                üì∑ Upload Photo
                            </button>
                        {% endif %}
                        <button class="btn btn-info set-dob-btn"
                                data-user-id="{{ profile.user.id }}"
                                data-username="{{ profile.user.username }}"
                                data-current-dob="{% if profile.player and profile.player.player_dob %}{{ profile.player.player_dob|date:'Y-m-d' }}{% endif %}">
                            üìÖ Set DOB
                        </button>
                        <button class="btn btn-danger delete-user-btn"
                                data-user-id="{{ profile.user.id }}"
                                data-username="{{ profile.user.username }}">
                            üóëÔ∏è Delete User
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Enter a new password for <strong id="resetUsername"></strong></p>
                <form id="resetPasswordForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="resetUserId">
                    <input type="hidden" name="action" value="reset_password">
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" name="new_password" required minlength="8">
                        <small class="password-hint">Password must be at least 8 characters long</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password:</label>
                        <input type="password" id="confirmPassword" name="confirm_password" required minlength="8">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Modal functionality
        const modal = document.getElementById('resetPasswordModal');
        const closeBtn = document.querySelector('.close');

        function openResetModal(userId, username) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        closeBtn.onclick = closeModal;

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Reset password buttons
        document.querySelectorAll('.reset-password-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                openResetModal(userId, username);
            });
        });

        // Handle form submission
        document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            const formData = new FormData(this);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password reset successfully!');
                    closeModal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while resetting the password.');
            });
        });
    </script>

    <!-- Upload Photo Modal -->
    <div id="uploadPhotoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Profile Photo</h2>
                <span class="close close-photo">&times;</span>
            </div>
            <div class="modal-body">
                <p>Upload a profile photo for <strong id="uploadUsername"></strong></p>
                <form id="uploadPhotoForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="uploadUserId">
                    <input type="hidden" name="action" value="upload_photo">
                    <div class="form-group">
                        <label for="photoInput">Select Photo:</label>
                        <input type="file" id="photoInput" name="photo" accept="image/*" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePhotoModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload Photo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete User</h2>
                <span class="close close-delete">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the user <strong id="deleteUsername"></strong>?</p>
                <p class="warning-text">‚ö†Ô∏è This action cannot be undone. All user data, including profile information and quiz history, will be permanently deleted.</p>
                <form id="deleteUserForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="deleteUserId">
                    <input type="hidden" name="action" value="delete_user">
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Upload photo modal functionality
        const photoModal = document.getElementById('uploadPhotoModal');
        const closePhotoBtn = document.querySelector('.close-photo');

        function openPhotoModal(userId, username) {
            document.getElementById('uploadUserId').value = userId;
            document.getElementById('uploadUsername').textContent = username;
            document.getElementById('photoInput').value = '';
            photoModal.style.display = 'block';
        }

        function closePhotoModal() {
            photoModal.style.display = 'none';
        }

        closePhotoBtn.onclick = closePhotoModal;

        // Upload photo buttons
        document.querySelectorAll('.upload-photo-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                openPhotoModal(userId, username);
            });
        });

        // Handle photo upload form submission
        document.getElementById('uploadPhotoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile photo uploaded successfully!');
                    closePhotoModal();
                    location.reload(); // Refresh to show the new photo
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the photo.');
            });
        });

        // Delete user modal functionality
        const deleteModal = document.getElementById('deleteUserModal');
        const closeDeleteBtn = document.querySelector('.close-delete');

        function openDeleteModal(userId, username) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUsername').textContent = username;
            deleteModal.style.display = 'block';
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
        }

        closeDeleteBtn.onclick = closeDeleteModal;

        // Delete user buttons
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                openDeleteModal(userId, username);
            });
        });

        // Handle delete user form submission
        document.getElementById('deleteUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            if (confirm('Are you absolutely sure you want to delete this user? This action cannot be undone.')) {
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('User deleted successfully!');
                        closeDeleteModal();
                        location.reload(); // Refresh to update the user list
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the user.');
                });
            }
        });
    </script>

    <!-- Set Date of Birth Modal -->
    <div id="setDobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Date of Birth</h2>
                <span class="close close-dob">&times;</span>
            </div>
            <div class="modal-body">
                <p>Set date of birth for <strong id="dobUsername"></strong></p>
                <form id="setDobForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="dobUserId">
                    <input type="hidden" name="action" value="set_dob">
                    <div class="form-group">
                        <label for="dobInput">Date of Birth:</label>
                        <input type="date" id="dobInput" name="date_of_birth" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeDobModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Set Date of Birth</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>        // Set DOB modal functionality
        const dobModal = document.getElementById("setDobModal");
        const closeDobBtn = document.querySelector(".close-dob");

        function openDobModal(userId, username, currentDob) {
            document.getElementById("dobUserId").value = userId;
            document.getElementById("dobUsername").textContent = username;
            document.getElementById("dobInput").value = currentDob || "";
            dobModal.style.display = "block";
        }

        function closeDobModal() {
            dobModal.style.display = "none";
        }

        closeDobBtn.onclick = closeDobModal;

        // Set DOB buttons
        document.querySelectorAll(".set-dob-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                const userId = this.getAttribute("data-user-id");
                const username = this.getAttribute("data-username");
                const currentDob = this.getAttribute("data-current-dob");
                openDobModal(userId, username, currentDob);
            });
        });

        // Handle DOB form submission
        document.getElementById("setDobForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch(window.location.href, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Date of birth set successfully!");
                    closeDobModal();
                    location.reload(); // Refresh to show the new DOB
                } else {
                    alert("Error: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while setting the date of birth.");
            });
        });
    </script>
{% endblock %}
